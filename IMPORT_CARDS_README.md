# Импорт карточек товаров из Wildberries

## Описание

Система автоматического импорта карточек товаров из API Wildberries с поддержкой пагинации и регулярного обновления данных.

## Возможности

- ✅ Автоматическая пагинация (обрабатывает все карточки без ограничений)
- ✅ Обновление существующих карточек при изменениях
- ✅ Поддержка нескольких продавцов
- ✅ Детальное логирование процесса
- ✅ Прогресс-бар для отслеживания процесса
- ✅ Обработка ошибок и восстановление
- ✅ Регулярное автоматическое обновление

## Использование команды

### Импорт всех карточек для всех продавцов

```bash
php artisan wb:import-cards
```

### Импорт карточек для конкретного продавца

```bash
php artisan wb:import-cards --seller-id=1
```

### Настройка лимита карточек за запрос

```bash
php artisan wb:import-cards --limit=50
```

### Комбинированное использование

```bash
php artisan wb:import-cards --seller-id=1 --limit=200
```

## Автоматическое обновление

Система настроена на автоматический запуск каждый час. Для активации добавьте в crontab:

```bash
* * * * * cd /path/to/project && php artisan schedule:run >> /dev/null 2>&1
```

### Варианты расписания

В `routes/console.php` можно изменить частоту запуска:

- `->hourly()` - каждый час (по умолчанию)
- `->everyFourHours()` - каждые 4 часа
- `->daily()` - раз в день
- `->twiceDaily(8, 20)` - дважды в день в 8:00 и 20:00

## Требования

1. **API ключи**: У продавцов должны быть настроены и зашифрованы API ключи
2. **База данных**: Должны быть выполнены миграции для таблиц `sellers` и `product_cards`
3. **Права доступа**: API ключи должны иметь права на чтение карточек товаров

## Структура данных

Каждая карточка товара сохраняется со следующими данными:

- Основные идентификаторы (nm_id, imt_id, nm_uuid)
- Информация о товаре (название, описание, бренд)
- Характеристики товара (JSON)
- Фотографии и видео (JSON)
- Размеры и габариты (JSON)
- Теги и категории (JSON)
- Даты создания и обновления

## Логирование

### Файлы логов

- **Команда**: `storage/logs/import-cards.log` - логи выполнения команды
- **Laravel**: `storage/logs/laravel.log` - общие логи приложения и ошибки API

### Мониторинг

Команда выводит детальную статистику:
- Количество обработанных карточек
- Количество созданных новых записей
- Количество обновленных записей
- Количество ошибок

## Troubleshooting

### Распространенные проблемы

1. **"Не найдено продавцов с API ключами"**
   - Убедитесь, что у продавцов заполнено поле `api_key`
   - Проверьте, что ключи правильно зашифрованы

2. **Ошибки API**
   - Проверьте валидность API ключей
   - Убедитесь в наличии прав доступа к API
   - Проверьте логи `storage/logs/laravel.log`

3. **Медленная работа**
   - Уменьшите параметр `--limit`
   - Проверьте скорость интернет-соединения
   - Убедитесь в производительности базы данных

### Отладка

Для детальной отладки используйте:

```bash
php artisan wb:import-cards --seller-id=1 -v
```

## API Reference

### WildberriesApiService

- `getProductCards($apiKey, $limit, $cursor)` - получение одной страницы карточек
- `getAllProductCards($apiKey, $limit)` - получение всех карточек с автоматической пагинацией
- `transformCardData($cardData, $sellerId)` - преобразование данных API в формат БД

### Модели

- **ProductCard** - модель карточки товара
- **Seller** - модель продавца с методом `getDecryptedApiKey()`

## Безопасность

- API ключи хранятся в зашифрованном виде
- Используются транзакции для целостности данных
- Логируются все ошибки для анализа
- Команда защищена от одновременного запуска (`withoutOverlapping`) 
